import*as global from"./modules/global.js";import{consoleLog,loadCssFile,loadJsFile,exeJsCode,preferesColorScheme,initDarkMode,sitecoreItemJson,getScItemData,startDrag}from"./modules/helpers.js";import{showSnackbar}from"./modules/snackbar.js";import{checkWorkbox}from"./modules/workbox.js";import{checkUrlStatus}from"./modules/url.js";import{checkNotification,sendNotification}from"./modules/notification.js";import{findCountryName}from"./modules/language.js";import{sitecoreAuthorToolbox}from"./modules/contenteditor.js";import{getGravatar}from"./modules/users.js";import{instantSearch}from"./modules/instantsearch.js";import{insertModal,insertPanel}from"./modules/menu.js";import{initMediaExplorer,initMediaCounter,initMediaDragDrop,initMediaViewButtons}from"./modules/media.js";import{insertSavebar,initInsertIcon,initGutter,getAccentColor,initColorPicker,initSitecoreMenu,initUserMenu}from"./modules/experimentalui.js";chrome.storage.sync.get(storage=>{let currentScheme=preferesColorScheme(),darkMode=!1;if(global.isSitecore&&!global.isEditMode&&!global.isLoginPage&&!global.isCss&&!global.isUploadManager){if(loadCssFile("css/onload.min.css"),loadJsFile("js/inject.min.js"),initDarkMode(storage),checkNotification(),!1===storage.feature_contrast_icons&&(document.documentElement.style.setProperty("--iconBrightness",1),document.documentElement.style.setProperty("--iconContrast",1)),global.isContentEditor||global.isLaunchpad){if(consoleLog("**** Content Editor / Launchpage ****","yellow"),null==storage.feature_experimentalui&&(storage.feature_experimentalui=!1),null==storage.feature_contrast_icons&&(storage.feature_contrast_icons=!1),!global.isLaunchpad&&storage.feature_experimentalui){let ScItem=getScItemData();loadCssFile("css/experimentalui.min.css"),initDarkMode(storage);let svgAnimation='<div id="svgAnimation">'+global.svgAnimation+"</div>";document.querySelector("#EditorFrames")&&document.querySelector("#EditorFrames").insertAdjacentHTML("beforebegin",svgAnimation);let SearchPanel=document.querySelector("#SearchPanel");SearchPanel&&(SearchPanel.innerHTML="Content"),insertSavebar(),insertModal(ScItem.id,ScItem.language,ScItem.version),insertPanel(),initInsertIcon(),initGutter(),initUserMenu(),initColorPicker(),initSitecoreMenu(),document.addEventListener("click",event=>{let topPos=document.querySelector("#EditorTabs").getBoundingClientRect().bottom,scPanel=document.querySelector("#scPanel"),scLanguageIframe=document.querySelector("#scLanguageIframe"),scVersionIframe=document.querySelector("#scVersionIframe");scPanel&&scPanel.setAttribute("style","top: "+topPos+"px !important"),scLanguageIframe&&scLanguageIframe.setAttribute("style","top: "+topPos+"px !important"),scVersionIframe&&scVersionIframe.setAttribute("style","top: "+topPos+"px !important"),document.querySelector(".scPublishMenu")&&("scPublishMenuMore"==event.srcElement.id?document.querySelector(".scPublishMenu").classList.toggle("visible"):document.querySelector(".scPublishMenu").classList.remove("visible")),document.querySelector(".scMoreMenu")&&("scMoreButton"==event.srcElement.id||"scMoreButton"==event.path[1].id?document.querySelector(".scMoreMenu").classList.toggle("visible"):document.querySelector(".scMoreMenu").classList.remove("visible")),"scInfoButton"==event.srcElement.id||"scInfoButton"==event.path[1].id||"scPanel"==event.srcElement.id||"content"==event.path[0].className?scPanel.classList.toggle("open"):scPanel.classList.remove("open"),scLanguageIframe&&("scLanguageButton"==event.srcElement.id||"scLanguageButton"==event.path[1].id?scLanguageIframe.classList.toggle("open"):scLanguageIframe.classList.remove("open")),scVersionIframe&&("scVersionButton"==event.srcElement.id||"scVersionButton"==event.path[1].id?scVersionIframe.classList.toggle("open"):scVersionIframe.classList.remove("open")),document.querySelector(".scPublishMenu"),document.querySelector("#scModal")&&("scOverlay"==event.srcElement.className&&document.querySelector(".scOverlay").setAttribute("style","visibility: hidden"),"scOverlay"==event.srcElement.className&&document.querySelector("#scModal").setAttribute("style","opacity:0; visibility: hidden; top: calc(50% - 550px/2 - 10px)"))})}if(null==storage.feature_instantsearch&&(storage.feature_instantsearch=!0),!global.isLaunchpad&&storage.feature_instantsearch){let globalHeader=document.querySelector(".sc-globalHeader"),html='<input type="text" class="scInstantSearch scIgnoreModified" placeholder="Search for content or media" tabindex="1" accesskey="f">',htmlResult='<ul class="scInstantSearchResults"></ul>';globalHeader&&globalHeader.insertAdjacentHTML("afterbegin",htmlResult),globalHeader&&globalHeader.insertAdjacentHTML("afterbegin",html),globalHeader&&instantSearch()}if(window.onpopstate=function(event){event.state&&""!=event.state.id&&(localStorage.setItem("scBackPrevious",!0),exeJsCode('scForm.invoke("item:load(id='+event.state.id+",language="+event.state.language+",version="+event.state.version+')");'))},storage.feature_darkmode&&storage.feature_darkmode_auto){const scheme=window.matchMedia("(prefers-color-scheme: dark)");scheme.addEventListener("change",()=>{exeJsCode("scForm.invoke('contenteditor:save', event)"),setTimeout((function(){window.location.reload()}),500)})}if(!global.hasRedirectionOther&&!global.isLaunchpad)if(null==storage.feature_reloadnode&&(storage.feature_reloadnode=!0),null==storage.scData||global.urlParams.get("fo")||global.urlParams.get("ro"))sitecoreAuthorToolbox();else{if(""!=global.scUrlHash)temp=global.scUrlHash.split("_"),storage.scItemID=temp[0],storage.scLanguage=temp[1],storage.scVersion=temp[2],storage.scSource="Hash";else{var scData=storage.scData;for(var domain in scData)scData.hasOwnProperty(domain)&&domain==window.location.origin&&(storage.scItemID=scData[domain].scItemID,storage.scLanguage=scData[domain].scLanguage,storage.scVersion=scData[domain].scVersion,storage.scSource="Storage")}null==storage.scLanguage&&(storage.scLanguage="en"),storage.scItemID&&!0===storage.feature_reloadnode&&(consoleLog("[Read "+storage.scSource+"] Item : "+storage.scItemID,"beige"),consoleLog("[Read "+storage.scSource+"] Language : "+storage.scLanguage,"beige"),consoleLog("[Read "+storage.scSource+"] Version : "+storage.scVersion,"beige"),consoleLog("*** Redirection ***","yellow"),exeJsCode('scForm.invoke("item:load(id='+storage.scItemID+",language="+storage.scLanguage+",version="+storage.scVersion+')");')),sitecoreAuthorToolbox()}if(null==storage.feature_favorites&&(storage.feature_favorites=!1),storage.feature_favorites&&!global.isPublishWindow&&global.scContentTree){var scFavoritesIframe=document.querySelector("#sitecorAuthorToolboxFav");let ScItem;scFavoritesIframe&&scFavoritesIframe.remove();var scFavoritesUrl,scMyShortcut='<iframe loading="lazy" id="sitecorAuthorToolboxFav" class="sitecorAuthorToolboxFav" src="'+("../default.aspx?xmlcontrol=Gallery.Favorites&id="+getScItemData().id+"&la=en&vs=1")+'" style="width:100%; height:150px; margin-top: 0px; resize: vertical;"></iframe>';global.scContentTree.insertAdjacentHTML("afterend",scMyShortcut)}if(!global.isLaunchpad){let snackbarVersion=global.extensionVersion;localStorage.getItem("sbDismiss")!=snackbarVersion&&showSnackbar(snackbarVersion)}null==storage.feature_workbox&&(storage.feature_workbox=!0),!chrome.runtime.error&&!0===storage.feature_workbox&&checkWorkbox()}if(global.isDesktop&&!global.isGalleryFavorites&&!global.isXmlControl&&(consoleLog("**** Desktop Shell ****","orange"),null==storage.feature_launchpad&&(storage.feature_launchpad=!0),storage.feature_experimentalui&&(loadCssFile("css/experimentalui.min.css"),initUserMenu(),initColorPicker(),initSitecoreMenu()),storage.feature_launchpad)){var html='<a href="#" class="scStartMenuLeftOption" title="" onclick="window.location.href=\''+global.launchpadPage+"?launchpad=true&url="+global.windowLocationHref+'\'"><img loading="lazy" src="'+global.launchpadIcon+'" class="scStartMenuLeftOptionIcon" alt="" border="0"><div class="scStartMenuLeftOptionDescription"><div class="scStartMenuLeftOptionDisplayName">'+global.launchpadGroupTitle+'</div><div class="scStartMenuLeftOptionTooltip">'+global.launchpadTitle+"</div></div></a>",desktopOptionMenu=document.querySelectorAll(".scStartMenuLeftOption");for(let item of desktopOptionMenu)"Install and maintain apps."==item.getAttribute("title")&&item.insertAdjacentHTML("afterend",html)}if(global.isLaunchpad){if(consoleLog("**** Launchpad ****","orange"),null==storage.feature_launchpad&&(storage.feature_launchpad=!0),null==storage.feature_launchpad_tiles&&(storage.feature_launchpad_tiles=!1),storage.feature_launchpad){var launchpadCol=document.querySelectorAll(".last");html='<div class="sc-launchpad-group"><header class="sc-launchpad-group-title">'+global.launchpadGroupTitle+'</header><div class="sc-launchpad-group-row"><a href="#" onclick="window.location.href=\''+global.launchpadPage+"?launchpad=true&url="+global.windowLocationHref+'\'" class="sc-launchpad-item" title="'+global.launchpadTitle+'"><span class="icon"><img loading="lazy" src="'+global.launchpadIcon+'" width="48" height="48" alt="'+global.launchpadTitle+'"></span><span class="sc-launchpad-text">'+global.launchpadTitle+"</span></a></div></div>",launchpadCol[0].insertAdjacentHTML("afterend",html)}storage.feature_launchpad_tiles&&(loadCssFile("css/tilelaunchpad.min.css"),(storage.feature_darkmode&&!storage.feature_darkmode_auto||storage.feature_darkmode&&storage.feature_darkmode_auto&&"dark"==currentScheme)&&loadCssFile("css/dark/tilelaunchpad.min.css"))}if(global.isSearch){consoleLog("**** Internal Search ****","orange");var target=document.querySelector("#results"),observer=new MutationObserver((function(){var resultsDiv,BlogPostArea=document.querySelector("#results").querySelectorAll(".BlogPostArea");for(var line of BlogPostArea){var BlogPostFooter=line.querySelector(".BlogPostFooter"),getFullpath=line.querySelector(".BlogPostViews > a > img").getAttribute("title");(getFullpath=(getFullpath=getFullpath.split(" - "))[1].toLowerCase()).includes("/home/")&&(getFullpath="/"+(getFullpath=getFullpath.split("/home/"))[1]);var getNumLanguages,html='<div class="BlogPostExtra BlogPostContent" style="padding: 5px 0 0px 78px; color: #0769d6"><strong>Sitecore path:</strong> '+getFullpath+" <strong>Languages available:</strong> "+line.querySelector(".BlogPostHeader > span").getAttribute("title")+"</div>";getFullpath&&BlogPostFooter.insertAdjacentHTML("afterend",html)}}));target&&observer.observe(target,{attributes:!1,childList:!0,characterData:!1,subtree:!1})}if(global.isFieldEditor){if(consoleLog("**** Field editor ****","orange"),null==storage.feature_contenteditor&&(storage.feature_contenteditor=!0),!0===storage.feature_contenteditor&&loadCssFile("css/checkbox.min.css"),null==storage.feature_charscount&&(storage.feature_charscount=!0),storage.feature_charscount){var scTextFields=document.querySelectorAll("input, textarea, checkbox"),countHtml,labelHtml,chars=0,charsText;for(var field of scTextFields)"scContentControl"==field.className||"scContentControlMemo"==field.className?(field.setAttribute("style","padding-right: 70px !important"),field.parentElement.setAttribute("style","position:relative !important"),chars=field.value.length,charsText=chars>1?chars+" chars":chars+" char",countHtml='<div id="chars_'+field.id+'" style="position: absolute; bottom: 1px; right: 1px; padding: 6px 10px; border-radius: 4px; line-height: 20px; opacity:0.5;">'+charsText+"</div>",field.insertAdjacentHTML("afterend",countHtml)):"scContentControlCheckbox"==field.className&&(labelHtml='<label for="'+field.id+'" class="scContentControlCheckboxLabel"></label>',field.insertAdjacentHTML("afterend",labelHtml));document.addEventListener("keyup",(function(event){"input"!=event.target.localName&&"textarea"!=event.target.localName||(chars=event.target.value.length,charsText=chars>1?chars+" chars":chars+" char",document.querySelector("#chars_"+event.target.id)&&(document.querySelector("#chars_"+event.target.id).innerText=charsText))}),!1)}var scBucketListSelectedBox=document.querySelectorAll(".scBucketListSelectedBox, .scContentControlMultilistBox"),Section_Data=document.querySelector("#Section_Data");(scBucketListSelectedBox=scBucketListSelectedBox[1]?scBucketListSelectedBox[1]:scBucketListSelectedBox[0])&&scBucketListSelectedBox.addEventListener("change",(function(){var itemId=scBucketListSelectedBox.value;itemId=itemId.includes("|")?itemId.split("|")[1]:itemId;var itemName=scBucketListSelectedBox[scBucketListSelectedBox.selectedIndex].text,scMessageEditText='<a class="scMessageBarOption" href="'+window.location.origin+"/sitecore/shell/Applications/Content%20Editor.aspx?sc_bw=1#"+itemId+'" target="_blank"><u>Click here ⧉</u></a> ',scMessageEdit='<div id="Warnings" class="scMessageBar scWarning"><div class="scMessageBarIcon" style="background-image:url('+global.icon+')"></div><div class="scMessageBarTextContainer"><div class="scMessageBarTitle">'+itemName+"</div>";scMessageEdit+='<span id="Information" class="scMessageBarText"><span class="scMessageBarOptionBullet">'+scMessageEditText+"</span> to edit this datasource in <b>Content Editor</b>.</span>",scMessageEdit+="</div></div>",document.querySelector(".scMessageBar")?(document.querySelector(".scMessageBarTitle").innerHTML=itemName,document.querySelector(".scMessageBarOptionBullet").innerHTML=scMessageEditText):Section_Data.insertAdjacentHTML("beforebegin",scMessageEdit)})),null==storage.feature_errors&&(storage.feature_errors=!0);var count=0,scErrors=document.getElementsByClassName("scValidationMarkerIcon"),scEditorID=document.querySelector("#MainPanel");if(storage.feature_errors){var scMessageErrors='<div id="scMessageBarError" class="scMessageBar scError"><div class="scMessageBarIcon" style="background-image:url('+global.iconError+')"></div><div class="scMessageBarTextContainer"><ul class="scMessageBarOptions" style="margin:0px">';for(let item of scErrors)"/sitecore/shell/themes/standard/images/bullet_square_yellow.png"!=item.getAttribute("src")&&(scMessageErrors+='<li class="scMessageBarOptionBullet" onclick="'+item.getAttribute("onclick")+'" style="cursor:pointer;">'+item.getAttribute("title")+"</li>",count++);let timer,element;scMessageErrors+="</ul></div></div>",count>0&&scEditorID.insertAdjacentHTML("beforebegin",scMessageErrors),target=document.querySelector(".scValidatorPanel"),observer=new MutationObserver((function(){timer&&clearTimeout(timer),timer=setTimeout((function(){element=document.querySelector("#scMessageBarError"),element&&element.parentNode.removeChild(element),count=0,scErrors=document.querySelectorAll(" .scValidationMarkerIcon ");var scMessageErrors='<div id="scMessageBarError" class="scMessageBar scError"><div class="scMessageBarIcon" style="background-image:url('+global.iconError+')"></div><div class="scMessageBarTextContainer"><ul class="scMessageBarOptions" style="margin:0px">';for(let item of scErrors)"/sitecore/shell/themes/standard/images/bullet_square_yellow.png"!=item.getAttribute("src")&&(scMessageErrors+='<li class="scMessageBarOptionBullet" onclick="'+item.getAttribute("onclick")+'" style="cursor:pointer;">'+item.getAttribute("title")+"</li>",count++);scMessageErrors+="</ul></div></div>",count>0&&scEditorID.insertAdjacentHTML("beforebegin",scMessageErrors)}),1500)})),target&&observer.observe(target,{attributes:!0,childList:!0,characterData:!0})}}if(global.isSourceBrowser&&consoleLog("**** Source Browser ****","orange"),global.isMediaFolder&&(consoleLog("**** Media Folder ****","orange"),null==storage.feature_dragdrop&&(storage.feature_dragdrop=!0),loadCssFile("css/tooltip.min.css"),storage.feature_experimentalui&&(loadCssFile("css/experimentalui.min.css"),getAccentColor(),!1===storage.feature_contrast_icons&&(document.documentElement.style.setProperty("--iconBrightness",1),document.documentElement.style.setProperty("--iconContrast",1))),initDarkMode(storage),initMediaDragDrop(),initMediaViewButtons(),initMediaCounter(),"list"==localStorage.getItem("scMediaView")&&initMediaExplorer(storage.feature_experimentalui),document.querySelector("#FileList")&&document.querySelector("#FileList").setAttribute("style","display:block")),global.isExperienceProfile&&(consoleLog("**** Experience Profile ****","orange"),null==storage.feature_gravatarimage&&(storage.feature_gravatarimage=!0),storage.feature_gravatarimage&&(target=document.querySelector("body"),observer=new MutationObserver((function(){let InfoPhotoImage=document.querySelector("img[data-sc-id=InfoPhotoImage]"),InfoEmailLink=document.querySelector("a[data-sc-id=InfoEmailLink]");InfoPhotoImage&&InfoEmailLink&&InfoEmailLink.innerHTML.includes("@")&&!InfoPhotoImage.src.includes("www.gravatar.com")&&(InfoPhotoImage.src=getGravatar(InfoEmailLink.innerHTML,170),observer.disconnect())})),target&&observer.observe(target,{attributes:!1,childList:!0,characterData:!0,subtree:!0}))),(global.isRichTextEditor||global.isHtmlEditor)&&(consoleLog("**** Rich Text Editor ****","orange"),null==storage.feature_rtecolor&&(storage.feature_rtecolor=!0),null==storage.feature_darkmode&&(storage.feature_darkmode=!1),null==storage.feature_darkmode_auto&&(storage.feature_darkmode_auto=!1),storage.feature_rtecolor)){var contentIframe,darkModeTheme="default";if(global.isRichTextEditor?contentIframe=document.querySelector("#Editor_contentIframe"):global.isHtmlEditor&&(contentIframe=document.querySelector("#ctl00_ctl00_ctl05_Html")),contentIframe){if(global.isRichTextEditor)var reTextArea=document.querySelector(".reTextArea");loadCssFile("css/codemirror.min.css"),(storage.feature_darkmode&&!storage.feature_darkmode_auto||storage.feature_darkmode&&storage.feature_darkmode_auto&&"dark"==currentScheme)&&(darkModeTheme="ayu-dark",loadCssFile("css/dark/ayu-dark.css")),global.isRichTextEditor?(reTextArea.insertAdjacentHTML("afterend",'<input type="hidden" class="scDarkMode" value="'+darkModeTheme+'" />'),reTextArea.insertAdjacentHTML("afterend",'<input type="hidden" class="scEditor" value="richTextEditor" />')):global.isHtmlEditor&&(contentIframe.insertAdjacentHTML("afterend",'<input type="hidden" class="scDarkMode" value="'+darkModeTheme+'" />'),contentIframe.insertAdjacentHTML("afterend",'<input type="hidden" class="scEditor" value="htmlEditor" />')),loadJsFile("js/bundle.min.js")}}if(global.isContentEditorApp&&storage.feature_experimentalui||global.isContentEditorApp&&storage.feature_instantsearch){let globalLogo=document.querySelector("#globalLogo");globalLogo&&globalLogo.setAttribute("target","_parent")}if(global.isEditorFolder&&(consoleLog("**** Editors folder ****","orange"),storage.feature_experimentalui&&(loadCssFile("css/experimentalui.min.css"),getAccentColor())),global.isXmlControl&&!global.isRichText&&(consoleLog("**** XML Control (Window) ****","orange"),storage.feature_experimentalui&&(loadCssFile("css/experimentalui.min.css"),getAccentColor())),global.isGalleryVersion&&(consoleLog("**** Versions menu ****","orange"),storage.feature_experimentalui&&(loadCssFile("css/experimentalui.min.css"),getAccentColor())),global.isLayoutDetails&&(consoleLog("**** Layout Details ****","orange"),document.querySelectorAll(".scRollOver").forEach((function(element){let attribute=element.getAttribute("onclick");attribute.substring(attribute.lastIndexOf("{")+1,attribute.lastIndexOf("}"))}))),global.isGalleryLanguage&&(consoleLog("**** Languages menu ****","orange"),storage.feature_experimentalui&&(loadCssFile("css/experimentalui.min.css"),getAccentColor()),null==storage.feature_flags&&(storage.feature_flags=!0),storage.feature_flags)){var dom=document.querySelector("#Languages"),div=dom.querySelectorAll(".scMenuPanelItem,.scMenuPanelItemSelected"),td,tdlanguage,tdversion,tdimage,temp,tdcount=0;(div=[].slice.call(div).sort((function(a,b){return a.querySelector("table > tbody > tr > td > div > div:last-child").textContent>b.querySelector("table > tbody > tr > td > div > div:last-child").textContent?-1:1}))).forEach((function(language){dom.appendChild(language)}));for(let item of div){tdcount=0,td=item.getElementsByTagName("td");for(let item2 of td){if(0==tdcount)tdimage=item2.getElementsByTagName("img");else{let rawVersion;tdlanguage=(tdlanguage=item2.getElementsByTagName("b"))[0].innerHTML,tdversion=(tdversion=(tdversion=item2.getElementsByTagName("div"))[2].innerHTML).split(" "),"fallback version"==item2.getElementsByTagName("div")[2].innerHTML.toLowerCase()?(temp=item2.getElementsByTagName("div"))[2].setAttribute("style","background-color: lime; display: initial; padding: 0px 3px; color: #000000 !important"):"0"!=tdversion[0]&&(temp=item2.getElementsByTagName("div"))[2].setAttribute("style","background-color: yellow; display: initial; padding: 0px 3px; color: #000000 !important"),tdlanguage=findCountryName(tdlanguage),tdimage[0].onerror=function(){this.src=global.iconFlagGeneric},tdimage[0].src=storage.feature_experimentalui?chrome.runtime.getURL("images/Flags/svg/"+tdlanguage+".svg"):chrome.runtime.getURL("images/Flags/32x32/flag_"+tdlanguage+".png")}tdcount++}}}if(global.isPublishDialog&&(consoleLog("**** Publishing window ****","orange"),null==storage.feature_flags&&(storage.feature_flags=!0),storage.feature_flags&&(target=document.querySelector("body"),observer=new MutationObserver((function(){var tdlanguage,label=document.querySelectorAll("div[data-sc-id=CheckBoxListLanguages] > table:last-child")[0];if(null!=label&&label.children[0].children.length>1)for(var tr of label.children[0].children)for(var td of tr.children)if(tdlanguage=findCountryName(td.innerText.trim()),null==td.querySelector("#scFlag")){let flag=storage.feature_experimentalui?chrome.runtime.getURL("images/Flags/svg/"+tdlanguage+".svg"):chrome.runtime.getURL("images/Flags/16x16/flag_"+tdlanguage+".png");td.querySelector("label > span").insertAdjacentHTML("beforebegin",' <img loading="lazy" id="scFlag" src="'+flag+'" style="display: inline !important; vertical-align: middle; padding-right: 2px; width:16px;" onerror="this.onerror=null;this.src=\''+global.iconFlagGeneric+"';\"/>")}})),target&&observer.observe(target,{attributes:!1,childList:!0,characterData:!1,subtree:!0}))),global.isPublishWindow&&(consoleLog("**** Publish / Rebuild / Package ****","orange"),storage.feature_experimentalui&&(loadCssFile("css/experimentalui.min.css"),getAccentColor()),!0===storage.feature_contenteditor&&(document.querySelectorAll("#PublishChildrenPane input[type=checkbox]").forEach((function(checkbox){checkbox.classList.add("scContentControlCheckbox");let labelHtml='<label for="'+checkbox.id+'" class="scContentControlCheckboxLabel"></label>';checkbox.insertAdjacentHTML("afterend",labelHtml)})),loadCssFile("css/checkbox.min.css")),null==storage.feature_flags&&(storage.feature_flags=!0),storage.feature_flags)){var label=document.querySelectorAll("#Languages > label");for(let item of label){tdlanguage=findCountryName(item.innerText.trim());let flag=storage.feature_experimentalui?chrome.runtime.getURL("images/Flags/svg/"+tdlanguage+".svg"):chrome.runtime.getURL("images/Flags/16x16/flag_"+tdlanguage+".png");item.insertAdjacentHTML("beforebegin",' <img loading="lazy" id="scFlag" src="'+flag+'" style="display: inline !important; vertical-align: middle; padding-right: 2px; width:16px" onerror="this.onerror=null;this.src=\''+global.iconFlagGeneric+"';\"/>")}}null==storage.feature_autoexpand&&(storage.feature_autoexpand=!0),null==storage.feature_autoexpandcount&&(storage.feature_autoexpandcount=!1),storage.feature_autoexpand&&(document.addEventListener("click",(function(event){if(null!=event.target.offsetParent&&event.target.offsetParent.matches(".scContentTreeNodeNormal")&&(storage.feature_experimentalui&&document.querySelector("#svgAnimation").setAttribute("style","opacity:1"),storage.feature_experimentalui?document.querySelector("#EditorFrames").setAttribute("style","opacity:0"):document.querySelector("#EditorFrames").setAttribute("style","opacity:0.5"),document.querySelector(".scContentTreeContainer").setAttribute("style","opacity:0.5"),document.querySelector(".scEditorTabHeaderActive > span").innerText=global.tabLoadingTitle,document.querySelector(".scPreviewButton")&&(document.querySelector(".scPreviewButton").innerText=global.tabLoadingTitle,document.querySelector(".scPreviewButton").disabled=!0),setTimeout((function(){document.querySelector("#svgAnimation")&&document.querySelector("#svgAnimation").setAttribute("style","opacity:0"),document.querySelector("#EditorFrames").setAttribute("style","opacity:1"),document.querySelector(".scContentTreeContainer").setAttribute("style","opacity:1")}),7e3)),event.target.matches(".scContentTreeNodeGlyph")){let glyphId=event.target.id;setTimeout((function(){if(document&&glyphId){let subTreeDiv=document.querySelector("#"+glyphId).nextSibling.nextSibling.nextSibling;if(subTreeDiv){let newNodes=subTreeDiv.querySelectorAll(".scContentTreeNode");1==newNodes.length&&newNodes[0].querySelector(".scContentTreeNodeGlyph").click(),storage.feature_autoexpandcount&&document.querySelectorAll(".scCountNodes").forEach((function(element){element.setAttribute("style","display:none")}))}else{let subTreeMain=document.querySelector("#"+glyphId).nextSibling.nextSibling;subTreeMain.querySelector(".scCountNodes")&&subTreeMain.querySelector(".scCountNodes").remove()}}}),200)}if(event.target.matches(".dynatree-expander")){let glyphId=event.path[1];setTimeout((function(){if(document&&glyphId){let subTreeDiv=glyphId.nextSibling;if(console.log(subTreeDiv),subTreeDiv){let newNodes=subTreeDiv.querySelectorAll(".dynatree-has-children");1==newNodes.length&&newNodes[0].querySelector(".dynatree-expander").click(),console.log(newNodes)}}}),200)}}),!1),document.addEventListener("mousedown",(function(event){if(!event.target.matches(".glyph"))return;let glyphId=event.target.id,glyphSrc,isCollapsed=event.target.src.includes("collapsed");setTimeout((function(){if(document&&glyphId&&isCollapsed){var subTreeDiv=document.querySelector("#"+glyphId).closest("ul").nextSibling,nextGlyphId;if(subTreeDiv)subTreeDiv.querySelector(".glyph").click()}}),200)}),!1)),loadCssFile("css/tooltip.min.css"),setTimeout((function(){document.querySelectorAll(".scContentTreeNodeGutterIcon").forEach((function(el){let parent=el.parentElement;console.log(el),parent.setAttribute("data-tooltip",el.getAttribute("title")),parent.classList.add("t-right"),parent.classList.add("t-xs"),el.removeAttribute("title")}))}),2500),target=document.querySelector("#LastPage"),observer=new MutationObserver((function(){if(null==storage.feature_notification&&(storage.feature_notification=!0),null==storage.feature_experimentalui&&(storage.feature_experimentalui=!1),storage.feature_notification){var notificationSubTitle=(target=document.querySelector("#LastPage")).querySelector(".sc-text-largevalue").innerHTML,notificationBody=target.querySelector(".scFieldLabel").innerHTML;"Result:"==notificationBody&&(notificationBody="Finished "+document.querySelector("#ResultText").value.split("Finished")[1]),sendNotification(notificationSubTitle,notificationBody),(storage.feature_darkmode&&!storage.feature_darkmode_auto||storage.feature_darkmode&&storage.feature_darkmode_auto&&"dark"==currentScheme)&&(darkMode=!0);var parentSelector=parent.parent.document.querySelector("body");checkUrlStatus(parentSelector.querySelector(".liveUrlStatus"),parentSelector,darkMode,storage.feature_experimentalui)}})),target&&observer.observe(target,{attributes:!0}),target=document.querySelector("#scLanguage"),observer=new MutationObserver((function(mutations){consoleLog("*** Update UI ***","yellow");var scQuickInfo=document.querySelector(".scEditorHeaderQuickInfoInput");if(scQuickInfo){var sitecoreItemID=scQuickInfo.getAttribute("value"),scLanguage=document.querySelector("#scLanguage").getAttribute("value").toLowerCase();let scVersion=document.querySelector(".scEditorHeaderVersionsVersion > span");scVersion=null!=scVersion?scVersion.innerText:1;var scEditorQuickInfo,countTab=document.querySelectorAll(".scEditorQuickInfo").length,scEditorTitle=document.getElementsByClassName("scEditorHeaderTitle"),tabSitecoreItemID=document.querySelectorAll(".scEditorHeaderQuickInfoInput"),lastTabSitecoreItemID=tabSitecoreItemID[tabSitecoreItemID.length-2].getAttribute("value"),locaStorage=localStorage.getItem("scBackPrevious");if(!global.hasRedirection&&!global.hasRedirectionOther&&!global.hasModePreview)if("true"!=locaStorage){var state={sitecore:!0,id:sitecoreItemID,language:scLanguage,version:scVersion};history.pushState(state,void 0,"#"+sitecoreItemID+"_"+scLanguage+"_"+scVersion)}else localStorage.removeItem("scBackPrevious");if(global.debug&&console.info("%c - Tabs opened: "+countTab+" ","font-size:12px; background: #7b3090; color: white; border-radius:5px; padding 3px;"),countTab>1&&!document.getElementById("showInContentTree"+countTab)){var url=window.location.href,href=(url=url.split("#"))[0]+"&reload#"+lastTabSitecoreItemID;scEditorTitle[countTab-1].insertAdjacentHTML("afterend",'[<a id="showInContentTree'+countTab+'" href="" onclick="javascript:window.location.href=\''+href+"'; return false;\" />Show in content tree</a>]")}}mutations.forEach((function(e){"attributes"==e.type&&sitecoreAuthorToolbox()}))})),target&&observer.observe(target,{attributes:!0})}if(global.isEditMode&&!global.isLoginPage||global.isPreviewMode&&!global.isLoginPage){consoleLog("Experience Editor detected","red"),loadCssFile("css/onload.min.css"),loadCssFile("css/tooltip.min.css"),loadJsFile("js/inject.min.js");let dataItemId=document.querySelector("[data-sc-itemid]"),dataItemLanguage=document.querySelector("[data-sc-language]"),dataItemVersion=document.querySelector("[data-sc-version]");if(dataItemId&&dataItemVersion){var sitecoreItemID=decodeURI(dataItemId.getAttribute("data-sc-itemid")),scLanguage=decodeURI(dataItemLanguage.getAttribute("data-sc-language")),scVersion=decodeURI(dataItemVersion.getAttribute("data-sc-version"));sitecoreItemJson(sitecoreItemID,scLanguage,scVersion)}if(global.isGalleryLanguageExpEd&&(consoleLog("**** Languages menu ****","yellow"),storage.feature_experimentalui&&(loadCssFile("css/experimentalui.min.css"),getAccentColor()),null==storage.feature_flags&&(storage.feature_flags=!0),storage.feature_flags)){var tdDiv;div=(dom=document.querySelector(".sc-gallery-content")).querySelectorAll("a[data-sc-argument]"),tdcount=0,(div=[].slice.call(div).sort((function(a,b){return a.querySelector("a > div > div:last-child > span").textContent>b.querySelector("a > div > div:last-child > span").textContent?-1:1}))).forEach((function(language){dom.appendChild(language)}));for(let item of div){tdDiv=item.querySelector(".sc-gallery-option-content,.sc-gallery-option-content-active"),tdlanguage=item.querySelector(".sc-gallery-option-content-header > span").innerText,"0"!=(temp=(tdversion=item.querySelector(".sc-gallery-option-content-description > span")).innerHTML.split(" "))[0]&&tdversion.setAttribute("style","background-color: yellow; display: initial; padding: 0px 3px; color: #000000 !important"),tdlanguage=findCountryName(tdlanguage);let flag=storage.feature_experimentalui?chrome.runtime.getURL("images/Flags/svg/"+tdlanguage+".svg"):chrome.runtime.getURL("images/Flags/32x32/flag_"+tdlanguage+".png");tdDiv.setAttribute("style","padding-left:48px; background-image: url("+flag+"); background-repeat: no-repeat; background-position: 5px; background-size: 32px")}}if(global.isRibbon){consoleLog("**** Ribbon ****","yellow");let scRibbonFlagIcons=document.querySelector(".flag_generic_24");if(scRibbonFlagIcons&&(tdlanguage=scRibbonFlagIcons.nextSibling.innerText),tdlanguage){tdlanguage=findCountryName(tdlanguage);let flag=storage.feature_experimentalui?chrome.runtime.getURL("images/Flags/svg/"+tdlanguage+".svg"):chrome.runtime.getURL("images/Flags/24x24/flag_"+tdlanguage+".png");scRibbonFlagIcons.setAttribute("style","background-image: url("+flag+"); background-repeat: no-repeat; background-position: top left;")}}target=document.querySelector(".scChromeDropDown"),observer=new MutationObserver((function(){let scChromeDropDownRow=document.querySelectorAll(".scChromeDropDownRow"),scLanguage=document.querySelector("#scLanguage").value,scVersion="";for(var row of scChromeDropDownRow)if("change associated content"==row.getAttribute("title").toLowerCase()){var id,html='<a href="#" title="Edit in Content Editor" class="scChromeDropDownRow" onclick="javascript:window.open(\'/sitecore/shell/Applications/Content%20Editor.aspx?sc_bw=1#{'+row.getAttribute("onclick").split("id={")[1].split("}")[0]+"}_"+scLanguage.toLowerCase()+'_\')"><img src="/~/icon/applicationsv2/32x32/window_edit.png" style="width:16px" alt="Edit in Content Editor"><span>Edit in Content Editor</span></a>';row.insertAdjacentHTML("beforebegin",html)}})),target&&observer.observe(target,{attributes:!1,childList:!0,characterData:!1}),target=document.querySelector(".scChromeControls"),observer=new MutationObserver((function(){var scChromeToolbar=document.querySelectorAll(".scChromeToolbar");for(var controls of scChromeToolbar){controls.setAttribute("style","margin-left:50px");var scChromeCommand=controls.querySelectorAll(".scChromeCommand"),changeColor=!1;for(var command of scChromeCommand){var title=command.getAttribute("title");command.setAttribute("style","z-index:auto"),!changeColor&&title&&(title.toLowerCase().includes("move component")||title.toLowerCase().includes("remove component")?(document.querySelectorAll(".scFrameSideHorizontal, .scFrameSideVertical").forEach((function(e){e.classList.remove("scFrameYellow")})),changeColor=!0):document.querySelectorAll(".scFrameSideHorizontal, .scFrameSideVertical").forEach((function(e){e.classList.add("scFrameYellow")}))),null!=title&&""!=title&&(command.setAttribute("data-tooltip",title),command.classList.add("t-bottom"),command.classList.add("t-md"),command.removeAttribute("title"))}}})),target&&observer.observe(target,{attributes:!0,childList:!0,characterData:!0});var pagemodeEdit=document.querySelector(".pagemode-edit");let tabColor;var linkNormalMode;!pagemodeEdit&&(pagemodeEdit=document.querySelector(".on-page-editor")),!pagemodeEdit&&(pagemodeEdit=document.querySelector(".experience-editor")),!pagemodeEdit&&(pagemodeEdit=document.querySelector(".scWebEditRibbon")),null==storage.feature_darkmode&&(storage.feature_darkmode=!1),null==storage.feature_darkmode_auto&&(storage.feature_darkmode_auto=!1),null==storage.feature_experienceeditor&&(storage.feature_experienceeditor=!0),storage.feature_experienceeditor&&loadCssFile("css/reset.min.css"),(storage.feature_darkmode&&!storage.feature_darkmode_auto&&global.isRibbon||storage.feature_darkmode&&!storage.feature_darkmode_auto&&global.isDialog||storage.feature_darkmode&&!storage.feature_darkmode_auto&&global.isInsertPage||storage.feature_darkmode&&storage.feature_darkmode_auto&&global.isRibbon&&"dark"==currentScheme||storage.feature_darkmode&&storage.feature_darkmode_auto&&global.isDialog&&"dark"==currentScheme||storage.feature_darkmode&&storage.feature_darkmode_auto&&global.isInsertPage&&"dark"==currentScheme)&&loadCssFile("css/dark/experience-min.css"),(storage.feature_darkmode&&!storage.feature_darkmode_auto||storage.feature_darkmode&&storage.feature_darkmode_auto&&"dark"==currentScheme)&&(tabColor="dark"),target=document.body,observer=new MutationObserver((function(mutations){for(var mutation of mutations)for(var addedNode of mutation.addedNodes)if("scCrossPiece"==addedNode.id){var html='<div class="scExpTab '+tabColor+'">\n                        <span class="tabHandle"></span>\n                        <span class="tabText" onclick="toggleRibbon()">▲ Hide<span>\n                        </div>';addedNode.insertAdjacentHTML("afterend",html),observer.disconnect(),startDrag(),document.addEventListener("keydown",event=>{"Shift"===event.key&&(exeJsCode("toggleRibbon()"),event.preventDefault(),event.stopPropagation())})}})),storage.feature_experienceeditor&&target&&observer.observe(target,{attributes:!1,childList:!0,characterData:!1}),linkNormalMode=global.isEditMode?global.windowLocationHref.replace("sc_mode=edit","sc_mode=normal"):global.isPreviewMode?global.windowLocationHref.replace("sc_mode=preview","sc_mode=normal"):global.windowLocationHref.includes("?")?global.windowLocationHref+"&sc_mode=normal":global.windowLocationHref+"?sc_mode=normal",storage.feature_experienceeditor&&!global.isRibbon&&(html='<div class="scNormalModeTab '+tabColor+'"><span class="t-right t-sm" data-tooltip="Open in Normal Mode"><a href="'+linkNormalMode+'" target="_blank"><img loading="lazy" src="'+global.iconChrome+'"/></a></span></div>',pagemodeEdit&&pagemodeEdit.insertAdjacentHTML("afterend",html)),storage.feature_experienceeditor&&!global.isRibbon&&(html='<div class="scContentEditorTab '+tabColor+'"><span class="t-right t-sm" data-tooltip="Open in Content Editor"><a href="'+window.location.origin+'/sitecore/shell/Applications/Content%20Editor.aspx?sc_bw=1"><img loading="lazy" src="'+global.iconCE+'"/></a></span></div>',pagemodeEdit&&pagemodeEdit.insertAdjacentHTML("afterend",html)),storage.feature_experienceeditor&&!global.isRibbon&&(html='<div class="scEditableTab '+tabColor+'"><span class="t-right t-sm" data-tooltip="Show/hide editable content"><a onclick="showEditableContent()"><img loading="lazy" src="'+global.iconED+'" id="scEditableImg" class="grayscaleClass"/></a></span></div>',pagemodeEdit&&pagemodeEdit.insertAdjacentHTML("afterend",html))}});